# ๐ง ุฅุนุฏุงุฏ ุฌุฏูู ุงูุงุดุชุฑุงูุงุช - ุฏููู ุงูุชุซุจูุช

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ุฌุฏูู `subscriptions` ูููุตู ูุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช ุจุดูู ุฃูุถู ูุฅููุงููุฉ ุฏูุฌ ุงูุฏูุน ุงูุฅููุชุฑููู ูุงุญูุงู.

## ๐จ ุฎุทูุงุช ุงูุชุซุจูุช

### ุงูุฎุทูุฉ 1: ุฅูุดุงุก ุฌุฏูู subscriptions

ูู ุจุชุดุบูู ุงูููู ุงูุชุงูู ูู Supabase SQL Editor:

```sql
-- ููู: create_subscriptions_table.sql
```

ูุฐุง ุงูููู ูููู ุจู:
- โ ุฅูุดุงุก ุฌุฏูู `subscriptions` ูุน ุฌููุน ุงูุญููู ุงููุทููุจุฉ
- โ ุฅูุดุงุก ุงูููุงุฑุณ ูุชุญุณูู ุงูุฃุฏุงุก
- โ ุฅุนุฏุงุฏ RLS (Row Level Security)
- โ ุฅูุดุงุก trigger ูุชุญุฏูุซ `updated_at` ุชููุงุฆูุงู

### ุงูุฎุทูุฉ 2: ุชุญุฏูุซ ุฏูุงู ุงูุงุดุชุฑุงูุงุช

ูู ุจุชุดุบูู ุงูููู ุงูุชุงูู:

```sql
-- ููู: subscriptions_management_functions.sql
```

ูุฐุง ุงูููู ูุญุชูู ุนูู:
- โ `create_user_subscription()` - ุฅูุดุงุก ุงุดุชุฑุงู ุฌุฏูุฏ ูู ุฌุฏูู subscriptions
- โ `admin_get_pending_subscriptions()` - ุฌูุจ ุงูุงุดุชุฑุงูุงุช ุงููุนููุฉ
- โ `admin_activate_subscription()` - ุชูุนูู ุงูุงุดุชุฑุงู
- โ `admin_cancel_subscription()` - ุฅูุบุงุก ุงูุงุดุชุฑุงู
- โ `admin_get_all_subscriptions()` - ุฌูุจ ุฌููุน ุงูุงุดุชุฑุงูุงุช
- โ `get_user_active_subscription()` - ุฌูุจ ุงุดุชุฑุงู ุงููุณุชุฎุฏู ุงููุดุท
- โ `update_expired_subscriptions()` - ุชุญุฏูุซ ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ (ููุงุณุชุฎุฏุงู ูุน cron job)
- โ `link_payment_to_subscription()` - ุฑุจุท payment ุจุงูุงุดุชุฑุงู (ููุฏูุน ุงูุฅููุชุฑููู)

### ุงูุฎุทูุฉ 3: ุชุญุฏูุซ ุฏูุงู packages_workflow

ูู ุจุชุดุบูู ุงูููู ุงูุชุงูู ูุชุญุฏูุซ ุงูุฏูุงู ุงูููุฌูุฏุฉ:

```sql
-- ููู: update_packages_workflow_for_subscriptions.sql
```

ูุฐุง ุงูููู ูููู ุจุชุญุฏูุซ:
- โ `get_user_package()` - ููุจุญุซ ูู subscriptions ุจุฏูุงู ูู payments
- โ `get_latest_active_payment()` - ููุจุญุซ ูู subscriptions
- โ `get_user_place_quota()` - ูุงุณุชุฎุฏุงู subscriptions
- โ `provider_priority()` - ูุงุณุชุฎุฏุงู subscriptions

## ๐ ุจููุฉ ุฌุฏูู subscriptions

```sql
CREATE TABLE subscriptions (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL,
    package_id BIGINT NOT NULL,
    
    -- ูุนูููุงุช ุงูุงุดุชุฑุงู
    status TEXT NOT NULL DEFAULT 'pending',  -- pending, active, expired, cancelled, suspended
    started_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,
    
    -- ูุนูููุงุช ุงูุฏูุน
    payment_id BIGINT,  -- ุฑุงุจุท ุจุฌุฏูู payments (ุนูุฏ ุชูุนูู ุงูุฏูุน ุงูุฅููุชุฑููู)
    amount NUMERIC NOT NULL,
    
    -- ูุนูููุงุช ุฅุถุงููุฉ
    auto_renew BOOLEAN DEFAULT FALSE,
    notes TEXT,
    
    -- ุงูุทูุงุจุน ุงูุฒูููุฉ
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

## ๐ ุงูุนูุงูุฉ ุจูู subscriptions ู payments

- **subscriptions**: ูุญุชูู ุนูู ูุนูููุงุช ุงูุงุดุชุฑุงู (ุงูุญุงูุฉุ ุงูุชูุงุฑูุฎุ ุฅูุฎ)
- **payments**: ูุญุชูู ุนูู ูุนูููุงุช ุงูุฏูุน (ุงููุจูุบุ ุญุงูุฉ ุงูุฏูุนุ ุฅูุฎ)
- **payment_id**: ุฑุงุจุท ุงุฎุชูุงุฑู ูู subscriptions ุฅูู payments

### ุงูุณููุงุฑูู ุงูุญุงูู (ุงูุฏูุน ุงููุฏูู):
1. ุฅูุดุงุก subscription ุจุญุงูุฉ `pending`
2. ุนูุฏ ุงูุชูุนูู: ุฅูุดุงุก payment ุชููุงุฆูุงู ูุฑุจุทู ุจุงูsubscription

### ุงูุณููุงุฑูู ุงููุณุชูุจูู (ุงูุฏูุน ุงูุฅููุชุฑููู):
1. ุฅูุดุงุก subscription ุจุญุงูุฉ `pending`
2. ุฅูุดุงุก payment ุนุจุฑ ุจูุงุจุฉ ุงูุฏูุน (Paymob, Stripe, etc.)
3. ุนูุฏ ูุฌุงุญ ุงูุฏูุน: ุฑุจุท payment ุจุงูsubscription ูุชูุนูู ุงูุงุดุชุฑุงู
4. ุงุณุชุฎุฏุงู `link_payment_to_subscription()` ูุฑุจุท payment ุงูููุฌูุฏ

## ๐ ุตูุงุญูุงุช RLS

### ูููุณุชุฎุฏููู:
- โ ูููููู ุฑุคูุฉ ุงุดุชุฑุงูุงุชูู ููุท
- โ ูููููู ุฅูุดุงุก ุงุดุชุฑุงูุงุช ูุฃููุณูู

### ูููุฏูุฑูู:
- โ ูููููู ุฑุคูุฉ ุฌููุน ุงูุงุดุชุฑุงูุงุช
- โ ูููููู ุชุญุฏูุซ ุงูุงุดุชุฑุงูุงุช (ุชูุนููุ ุฅูุบุงุกุ ุฅูุฎ)
- โ ูููููู ุญุฐู ุงูุงุดุชุฑุงูุงุช

## ๐ ุญุงูุงุช ุงูุงุดุชุฑุงู (Status)

- **pending**: ูู ุงูุชุธุงุฑ ุงูุชูุนูู (ุจุนุฏ ุทูุจ ุงูุงุดุชุฑุงู ููุจู ุงูุฏูุน)
- **active**: ูุดุท (ููุนูู ูููุณ ููุชููุงู)
- **expired**: ููุชูู (ุงูุชูุช ุตูุงุญูุชู)
- **cancelled**: ููุบู (ุชู ุฅูุบุงุคู ูู ูุจู ุงููุฏูุฑ ุฃู ุงููุณุชุฎุฏู)
- **suspended**: ูุนูู (ุชู ุชุนูููู ูุคูุชุงู)

## ๐ ุงูุชุญุฏูุซ ุงูุชููุงุฆู ููุงุดุชุฑุงูุงุช ุงูููุชููุฉ

ููููู ุชุดุบูู ุฏุงูุฉ `update_expired_subscriptions()` ูู cron job ูุชุญุฏูุซ ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ ุชููุงุฆูุงู:

```sql
-- ูู Supabase: Database > Cron Jobs
SELECT cron.schedule(
  'update-expired-subscriptions',
  '0 * * * *',  -- ูู ุณุงุนุฉ
  $$SELECT update_expired_subscriptions()$$
);
```

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### 1. ุงุฎุชุจุงุฑ ุฅูุดุงุก ุงุดุชุฑุงู:
```sql
SELECT create_user_subscription(1);  -- ุญูุซ 1 ูู package_id
```

### 2. ุงุฎุชุจุงุฑ ุฌูุจ ุงูุงุดุชุฑุงูุงุช ุงููุนููุฉ:
```sql
SELECT * FROM admin_get_pending_subscriptions();
```

### 3. ุงุฎุชุจุงุฑ ุชูุนูู ุงุดุชุฑุงู:
```sql
SELECT admin_activate_subscription(1);  -- ุญูุซ 1 ูู subscription_id
```

## ๐ฏ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ

### โ ุฅุฏุงุฑุฉ ุฃูุถู:
- ุฌุฏูู ูููุตู ููุงุดุชุฑุงูุงุช ูุณูู ุงูุฅุฏุงุฑุฉ
- ุญุงูุฉ ุงูุงุดุชุฑุงู ูููุตูุฉ ุนู ุญุงูุฉ ุงูุฏูุน
- ุฅููุงููุฉ ุฅุถุงูุฉ ููุงุญุธุงุช ููู ุงุดุชุฑุงู

### โ ุฌุงูุฒ ููุฏูุน ุงูุฅููุชุฑููู:
- ุฑุจุท ูุฑู ุจูู subscriptions ู payments
- ุฏุงูุฉ ุฌุงูุฒุฉ ูุฑุจุท payment ุจุงูุงุดุชุฑุงู
- ุฅููุงููุฉ ุฅูุดุงุก payment ูููุตู ุซู ุฑุจุทู

### โ ูุฑููุฉ ุฃูุจุฑ:
- ุฅููุงููุฉ ุฅุถุงูุฉ auto_renew ููุงุดุชุฑุงูุงุช
- ุฅููุงููุฉ ุชุนููู ุงูุงุดุชุฑุงูุงุช
- ุชุชุจุน ุฃูุถู ููุชูุงุฑูุฎ (started_at, expires_at)

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ุงูุชุฑุงุฌุน ุนู ุงููุธุงู ุงููุฏูู**: ุชุฃูุฏ ูู ูุณุฎ ุจูุงูุงุช ุงูุงุดุชุฑุงูุงุช ุงููุฏููุฉ ูู `payments` ุฅูู `subscriptions` ุฅู ูุงู ูุฏูู ุจูุงูุงุช ููุฌูุฏุฉ

2. **ุงูุชูุงูู ูุน ุงูููุฏ ุงููุฏูู**: ุชู ุชุญุฏูุซ ุฌููุน ุงูุฏูุงู ูุงุณุชุฎุฏุงู `subscriptions`ุ ููู ุชุฃูุฏ ูู ุชุญุฏูุซ ุฃู ููุฏ ุขุฎุฑ ูุณุชุฎุฏู `payments` ูุจุงุดุฑุฉ ููุงุดุชุฑุงูุงุช

3. **ุงูุฃุฏุงุก**: ุงูููุงุฑุณ ุชู ุฅูุดุงุคูุง ูุชุญุณูู ุงูุฃุฏุงุกุ ููู ููููู ุฅุถุงูุฉ ุงููุฒูุฏ ุญุณุจ ุงุญุชูุงุฌุงุชู

## ๐ ุงูุฏุนู

ูู ุญุงูุฉ ูุฌูุฏ ุฃู ูุดุงูู:
1. ุชุญูู ูู ุณุฌูุงุช Supabase
2. ุชุฃูุฏ ูู ุชุดุบูู ุฌููุน ุงููููุงุช ุจุงูุชุฑุชูุจ
3. ุชุญูู ูู ุตูุงุญูุงุช RLS

