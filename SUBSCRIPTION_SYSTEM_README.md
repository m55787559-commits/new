# ูุธุงู ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช - ุฏููู ุงูุงุณุชุฎุฏุงู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุญุฏูุซ ูุธุงู ุงูุงุดุชุฑุงูุงุช ููุนูู ุจุขููุฉ ุงูุฏูุน ุงููุฏูู (Manual Payment) ุญูุซ:
1. ุงููุณุชุฎุฏู ูุทูุจ ุงูุงุดุชุฑุงู
2. ูุชู ุฅูุดุงุก ุทูุจ ุจุญุงูุฉ `pending` (ูู ุงูุชุธุงุฑ ุงูุชูุนูู)
3. ูุธูุฑ ูููุณุชุฎุฏู ูุนูููุงุช ุญุณุงุจ ุงูุฏูุน
4. ุงููุฏูุฑ ูุชุญูู ูู ุงูุฏูุน ูููุนูู ุงูุงุดุชุฑุงู

## ๐ง ุงูุชุซุจูุช ูุงูุชูุนูู

### 1. ุชุดุบูู ุฏูุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช

ูู ุจุชุดุบูู ููู SQL ุงูุชุงูู ูู Supabase SQL Editor:

```sql
-- ููู: subscription_management_functions.sql
```

ูุฐุง ุงูููู ูุญุชูู ุนูู:
- `create_user_subscription()` - ุชุนุฏูู ุงูุฏุงูุฉ ุงูุญุงููุฉ ูุฅูุดุงุก payment ุจุญุงูุฉ `pending`
- `admin_get_pending_subscriptions()` - ุฌูุจ ุฌููุน ุงูุงุดุชุฑุงูุงุช ุงููุนููุฉ
- `admin_activate_subscription()` - ุชูุนูู ุงูุงุดุชุฑุงู
- `admin_cancel_subscription()` - ุฅูุบุงุก ุงูุงุดุชุฑุงู ุงููุนูู
- `admin_get_all_subscriptions()` - ุฌูุจ ุฌููุน ุงูุงุดุชุฑุงูุงุช

### 2. ุงูุชุฃูุฏ ูู ุจููุฉ ุฌุฏูู payments

ุชุฃูุฏ ูู ุฃู ุฌุฏูู `payments` ูุญุชูู ุนูู ุงูุญููู ุงูุชุงููุฉ:
- `id` (bigint)
- `user_id` (uuid)
- `package_id` (bigint)
- `status` (text) - ุงูููู: 'pending', 'completed', 'cancelled', 'failed'
- `amount` (numeric)
- `created_at` (timestamptz)
- `completed_at` (timestamptz, nullable)
- `payment_receipt_url` (text, nullable) - ุฑุงุจุท ุตูุฑุฉ ุฅูุตุงู ุงูุฏูุน

ุฅุฐุง ูุงู ุญูู `payment_receipt_url` ุบูุฑ ููุฌูุฏุ ูู ุจุฅุถุงูุชู:

```sql
ALTER TABLE payments 
ADD COLUMN IF NOT EXISTS payment_receipt_url text;
```

### 3. ุชุฎุตูุต ูุนูููุงุช ุญุณุงุจ ุงูุฏูุน

ูู ููู `subscription_management_functions.sql`ุ ููููู ุชุนุฏูู ูุนูููุงุช ุญุณุงุจ ุงูุฏูุน ูู ุฏุงูุฉ `create_user_subscription`:

```sql
'payment_info', jsonb_build_object(
  'bank_account', '1234567890',  -- ุฑูู ุงูุญุณุงุจ ุงูุจููู
  'bank_name', 'ุงูุจูู ุงูุฃููู ุงููุตุฑู',  -- ุงุณู ุงูุจูู
  'account_name', 'ุดุฑูุฉ ููู ุจุงู',  -- ุงุณู ุตุงุญุจ ุงูุญุณุงุจ
  'mobile_wallet', '01012345678',  -- ุฑูู ุงููุญูุธุฉ
  'instructions', 'ูุฑุฌู ุฅุฑุณุงู ุตูุฑุฉ ุฅูุตุงู ุงูุฏูุน ุนุจุฑ ุงููุงุชุณุงุจ ุนูู: 01012345678'
)
```

## ๐ฑ ุงุณุชุฎุฏุงู ุงููุธุงู

### ูููุณุชุฎุฏููู (Users)

1. **ุงูุฐูุงุจ ุฅูู ุตูุญุฉ ุงูุจุงูุงุช**: `/packages`
2. **ุงุฎุชูุงุฑ ุจุงูุฉ ูุงูุถุบุท ุนูู "ุงุดุชุฑู ุงูุขู"**
3. **ุชุฃููุฏ ุงูุงุดุชุฑุงู** ูู ุงููุงูุฐุฉ ุงูููุจุซูุฉ
4. **ูุดุงูุฏุฉ ูุนูููุงุช ุงูุฏูุน**:
   - ุฑูู ุงูุญุณุงุจ ุงูุจููู
   - ุงุณู ุงูุจูู
   - ุฑูู ุงููุญูุธุฉ ุงูุฅููุชุฑูููุฉ
   - ุชุนูููุงุช ุฅุชูุงู ุงูุฏูุน
5. **ุฅุชูุงู ุนูููุฉ ุงูุฏูุน** ุญุณุจ ุงููุนูููุงุช ุงููุนุฑูุถุฉ
6. **ุงูุชุธุงุฑ ุงูุชูุนูู** ูู ูุจู ุงูุฅุฏุงุฑุฉ (ุฎูุงู ุฏูุงุฆู)

### ููุฅุฏุงุฑุฉ (Admins)

1. **ุงูุฐูุงุจ ุฅูู ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช**: `/admin/subscriptions`
2. **ุนุฑุถ ุงูุงุดุชุฑุงูุงุช ุงููุนููุฉ** (ุงูููุชุฑ ุงูุงูุชุฑุงุถู)
3. **ุงูุชุญูู ูู ุนูููุฉ ุงูุฏูุน** (ุนุจุฑ ุงููุงุชุณุงุจ ุฃู ุงูุจูู)
4. **ุชูุนูู ุงูุงุดุชุฑุงู**:
   - ุงูุถุบุท ุนูู ุฒุฑ "โ ุชูุนูู" ุจุฌุงูุจ ุงูุงุดุชุฑุงู ุงููุทููุจ
   - ุชุฃููุฏ ุงูุชูุนูู
   - ูุชู ุชูุนูู ุงูุงุดุชุฑุงู ุชููุงุฆูุงู

5. **ุฅูุบุงุก ุงูุงุดุชุฑุงู** (ุฅู ูุฒู):
   - ุงูุถุบุท ุนูู ุฒุฑ "โ ุฅูุบุงุก"
   - ุฅุฏุฎุงู ุณุจุจ ุงูุฅูุบุงุก (ุงุฎุชูุงุฑู)

## ๐ ุงูููุฒุงุช

### ููุชุฑุฉ ุงูุงุดุชุฑุงูุงุช
- **ุงููุนููุฉ**: ุนุฑุถ ุงูุงุดุชุฑุงูุงุช ุงูุชู ูู ุงูุชุธุงุฑ ุงูุชูุนูู ููุท
- **ุงููู**: ุนุฑุถ ุฌููุน ุงูุงุดุชุฑุงูุงุช (ูุนููุฉุ ููุนููุฉุ ููุบุงุฉ)

### ูุนูููุงุช ุดุงููุฉ
ูู ุงุดุชุฑุงู ูุนุฑุถ:
- ุงุณู ุงููุณุชุฎุฏู ูุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- ุงุณู ุงูุจุงูุฉ ูุงูุณุนุฑ
- ุชุงุฑูุฎ ุงูุทูุจ
- ุญุงูุฉ ุงูุงุดุชุฑุงู
- ุฑุงุจุท ุฅูุตุงู ุงูุฏูุน (ุฅู ูุฌุฏ)

## โ๏ธ ุงูุฏูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

ุฌููุน ุงูุฏูุงู ุชุณุชุฎุฏู `security definer` ูุถูุงู:
- ุชูููุฐูุง ุจุตูุงุญูุงุช ุขููุฉ
- ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู ูุจู ุงูุชูููุฐ

### ุฏุงูุฉ create_user_subscription

**ุงููุฏุฎูุงุช:**
- `p_package_id` (bigint) - ูุนุฑู ุงูุจุงูุฉ

**ุงููุฎุฑุฌุงุช:**
- JSONB ูุญุชูู ุนูู:
  - `payment_id` - ูุนุฑู ุงูุฏูุนุฉ
  - `package_id` - ูุนุฑู ุงูุจุงูุฉ
  - `package_name` - ุงุณู ุงูุจุงูุฉ
  - `amount` - ุงููุจูุบ
  - `status` - ุงูุญุงูุฉ (pending)
  - `message` - ุฑุณุงูุฉ ูููุณุชุฎุฏู
  - `payment_info` - ูุนูููุงุช ุญุณุงุจ ุงูุฏูุน

### ุฏุงูุฉ admin_get_pending_subscriptions

**ุงููุฏุฎูุงุช:** ูุง ููุฌุฏ

**ุงููุฎุฑุฌุงุช:**
- ุฌุฏูู ูุญุชูู ุนูู ุฌููุน ุงูุงุดุชุฑุงูุงุช ุงููุนููุฉ ูุน ุชูุงุตูููุง ุงููุงููุฉ

### ุฏุงูุฉ admin_activate_subscription

**ุงููุฏุฎูุงุช:**
- `p_payment_id` (bigint) - ูุนุฑู ุงูุฏูุนุฉ

**ุงููุฎุฑุฌุงุช:**
- JSONB ูุญุชูู ุนูู ุฑุณุงูุฉ ุงููุฌุงุญ ููุนูููุงุช ุงูุชูุนูู

**ุงูุฅุฌุฑุงุกุงุช:**
- ุชุบููุฑ `status` ูู `pending` ุฅูู `completed`
- ุชุนููู `completed_at` ููููุช ุงูุญุงูู

## ๐ ุงูุฃูุงู

- ุฌููุน ุงูุฏูุงู ุงูุฅุฏุงุฑูุฉ ุชุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู (admin/owner)
- ุงูุฏูุงู ุชุณุชุฎุฏู `security definer` ูุถูุงู ุงูุชูููุฐ ุงูุขูู
- ุงูุชุญูู ูู ุญุงูุฉ ุงูุงุดุชุฑุงู ูุจู ุงูุชูุนูู/ุงูุฅูุบุงุก

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุญุงูุฉ ุงูุงุดุชุฑุงู**: ูุฌุจ ุฃู ุชููู `completed` ุญุชู ุชุธูุฑ ุงูุจุงูุฉ ูููุณุชุฎุฏู
2. **ุงูุชูุนูู ุงูุชููุงุฆู**: ุจุนุฏ ุชูุนูู ุงูุงุดุชุฑุงูุ ุณูุชู ุงุญุชุณุงุจ ุชุงุฑูุฎ ุงูุงูุชูุงุก ุชููุงุฆูุงู ุจูุงุกู ุนูู `duration_days` ููุจุงูุฉ
3. **ุฅูุตุงู ุงูุฏูุน**: ูููู ูููุณุชุฎุฏู ุฑูุน ุฅูุตุงู ุงูุฏูุน ุนุจุฑ ุญูู `payment_receipt_url` (ุฅู ูุงู ููุฌูุฏุงู ูู ุงููุงุฌูุฉ)
4. **ุงูุชุญูู ูู ุงูุฏูุน**: ูุฌุจ ุนูู ุงูุฅุฏุงุฑุฉ ุงูุชุญูู ูู ุนูููุฉ ุงูุฏูุน ูุจู ุงูุชูุนูู

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุณุชุฎุฏู ูุง ูุฑู ุงูุจุงูุฉ ุจุนุฏ ุงูุชูุนูู
- ุชุฃูุฏ ูู ุฃู `status = 'completed'` ูู ุฌุฏูู `payments`
- ุชุฃูุฏ ูู ุฃู `completed_at` ุบูุฑ null
- ุชุฃูุฏ ูู ุฃู ุงูุจุงูุฉ ูุดุทุฉ (`is_active = true`)

### ุฎุทุฃ "forbidden: admin only"
- ุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ูุฏูู role = 'admin' ุฃู 'owner' ูู ุฌุฏูู `user_profiles`

### ุฎุทุฃ ูู ุฌูุจ ุงูุงุดุชุฑุงูุงุช
- ุชุฃูุฏ ูู ุชุดุบูู ุฌููุน ุงูุฏูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุชุฃูุฏ ูู ุตูุงุญูุงุช RLS ุนูู ุฌุฏูู `payments`

## ๐ ุงูุฏุนู

ูู ุญุงูุฉ ูุฌูุฏ ุฃู ูุดุงููุ ุชุญูู ูู:
1. ุณุฌูุงุช ุงูุฃุฎุทุงุก ูู console ุงููุชุตูุญ
2. ุณุฌูุงุช Supabase
3. ุญุงูุฉ ุงูุฌุฏุงูู ูุงูุฏูุงู ูู Database Checker

